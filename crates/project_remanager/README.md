# Project Reorganizer (project_remanager)

A Rust crate for reorganizing scattered C-to-Rust translated projects into a unified, compilable Rust workspace.

## Philosophy

> "Bad programmers worry about the code. Good programmers worry about data structures and their relationships." - Linus Torvalds

This module does **one thing well**: it takes the individual Rust projects generated by the C2Rust translation process and reorganizes them into a proper Rust workspace structure that actually compiles and runs.

No fancy abstractions, no over-engineering. Just move files around and generate the right config files.

## What it does

After C-to-Rust translation, you end up with a structure like this:
```
src_cache/
├── individual_files/
│   ├── main/rust_project/          # Has main.rs
│   ├── parser/rust_project/        # Library module  
│   ├── tokenizer/rust_project/     # Library module
│   └── utils/rust_project/         # Library module
├── mapping.json
└── processing_report.json
```

The reorganizer converts this into a proper Rust project:
```
output/
├── Cargo.toml                      # Workspace config
├── src/
│   ├── lib.rs                      # Main library entry point
│   ├── bin/
│   │   └── main.rs                 # Executable binaries
│   ├── parser/
│   │   └── lib.rs                  # Parser module
│   ├── tokenizer/
│   │   └── lib.rs                  # Tokenizer module
│   └── utils/
│       └── lib.rs                  # Utils module
```

## Usage

### As a Library

```rust
use project_remanager::ProjectReorganizer;
use std::path::PathBuf;

let src_cache = PathBuf::from("./test-projects/translate_chibicc/src_cache");
let output = PathBuf::from("./reorganized_project");

let reorganizer = ProjectReorganizer::new(src_cache, output);
reorganizer.reorganize()?;
```

### As a Command Line Tool

```bash
# Build the tool
cargo build --bin project_remanager

# Run it
./target/debug/project_remanager ./test-projects/translate_chibicc/src_cache ./output/chibicc_rust

# Or with cargo run
cargo run --bin project_remanager -- ./test-projects/translate_chibicc/src_cache ./output/chibicc_rust
```

### Example Usage

```bash
# From the c2rust_agent directory
cargo run --bin project_remanager -- ./test-projects/translate_chibicc/src_cache ./reorganized_chibicc

# Check the result
cd ./reorganized_chibicc
cargo check
cargo build
cargo run --bin main  # If there's a main binary
```

## Project Structure

The reorganizer follows these rules:

1. **Binary programs** (projects with `main.rs`) → `src/bin/`
2. **Library modules** (projects without `main.rs`) → `src/module_name/`
3. **Dependencies** are collected and unified in the workspace `Cargo.toml`
4. **Main lib.rs** is generated to expose all library modules

## What Gets Reorganized

### Input Structure (src_cache)
- `individual_files/*/rust_project/` - Individual Rust projects
- `mapping.json` - File mapping information (for reference)
- Other files are ignored

### Output Structure
- `Cargo.toml` - Workspace configuration with all dependencies
- `src/lib.rs` - Main library file that exports all modules
- `src/bin/*.rs` - Executable binaries (from projects with main.rs)
- `src/*/lib.rs` - Library modules (from projects without main.rs)

## Key Features

- **Zero Breaking Changes**: Never modifies the original src_cache
- **Smart Dependency Handling**: Merges and deduplicates dependencies
- **Workspace Structure**: Creates proper Rust workspace with multiple targets
- **Error Resilient**: Handles missing files and malformed projects gracefully

## Requirements

- Rust 1.70+ (2021 edition)
- Source projects must be in `src_cache/individual_files/*/rust_project/` format
- Write permissions to the output directory

## Examples

Run the provided example:

```bash
cargo run --example reorganize_example
```

## Testing

```bash
cargo test
```

## Error Handling

The reorganizer handles common issues gracefully:

- Missing or malformed `Cargo.toml` files
- Projects without source files
- Dependency conflicts
- Permission issues

All errors are reported with context using the `anyhow` crate.

## Performance

This is file I/O bound work. Performance is good enough for typical translation projects (hundreds of files). If you have thousands of files, it might take a few seconds.

## Dependencies

- `anyhow` - Error handling
- `serde` - JSON parsing for metadata
- `toml` - Cargo.toml file parsing

## Contributing

Keep it simple. This module should do one thing well: reorganize files. Don't add features unless they're absolutely necessary.

## License

Same as the parent project.